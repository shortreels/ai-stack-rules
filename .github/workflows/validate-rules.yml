name: Validate Rules

on:
  pull_request:
    paths:
      - 'rules/**/*.json'
  push:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Validate JSON files with debugging
        run: |
          echo "=== Starting JSON validation with debug info ==="
          echo ""
          
          # First, list all JSON files
          echo "üìÅ Found JSON files:"
          ls -la rules/*.json 2>/dev/null || echo "No JSON files found in rules/"
          echo ""
          
          for file in rules/*.json; do
            if [ -f "$file" ]; then
              echo "=============================================="
              echo "üîç Validating: $file"
              echo "=============================================="
              
              # Show file size
              echo "üìè File size: $(wc -c < "$file") bytes"
              
              # Show first 100 characters
              echo "üìÑ First 100 chars:"
              head -c 100 "$file"
              echo ""
              echo ""
              
              # Show first 3 lines
              echo "üìù First 3 lines:"
              head -n 3 "$file"
              echo ""
              
              # Show invisible characters (cat -A shows $ for line endings, ^I for tabs)
              echo "üëª Invisible characters (cat -A):"
              cat -A "$file" | head -5
              echo ""
              
              # Check for UTF-8 BOM
              echo "üî§ Checking for BOM/encoding issues..."
              if [[ $(head -c 3 "$file") == $'\xef\xbb\xbf' ]]; then
                echo "‚ö†Ô∏è  WARNING: UTF-8 BOM detected at start of file!"
              fi
              
              # Hex dump of first 20 bytes
              echo "üî¢ Hex dump (first 20 bytes):"
              head -c 20 "$file" | xxd
              echo ""
              
              # Now validate with Python - capture error
              echo "‚úÖ Validating JSON structure..."
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "üéâ SUCCESS: $file is valid JSON!"
              else
                echo "‚ùå ERROR: $file contains invalid JSON!"
                echo ""
                echo "üìõ Error details:"
                python3 -m json.tool "$file" 2>&1 || true
                echo ""
                echo "üí° Suggestion: Create a fresh JSON file with:"
                echo 'echo '"'"'{"test": "valid"}'"'"' > "$file"'
                exit 1
              fi
              
              echo ""
              echo ""
            fi
          done
          
          # Also check subdirectories
          find rules -name "*.json" -type f | while read -r file; do
            if [ -f "$file" ]; then
              echo "=============================================="
              echo "üîç Validating: $file"
              echo "=============================================="
              
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "üéâ SUCCESS: $file is valid JSON!"
              else
                echo "‚ùå ERROR: $file contains invalid JSON!"
                python3 -m json.tool "$file" 2>&1 || true
                exit 1
              fi
              echo ""
            fi
          done
          
          echo "=============================================="
          echo "üéä All JSON files passed validation!"
          echo "=============================================="
